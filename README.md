# 加密货币趋势监控机器人

基于技术指标分析的加密货币趋势监控机器人，支持 BTC 和 ETH 的实时趋势分析和 Telegram 通知。

## 功能特性

- **多时间框架分析**：15分钟、1小时、4小时、1天、1周趋势监控
- **高频数据收集**：每5分钟收集5分钟K线数据并存储到数据库
- **智能分析**：基于 ADX、DMI、SMA、布林带、ATR 等技术指标
- **趋势通知**：任何时间框架趋势变化时自动发送 Telegram 通知
- **数据管理**：原始数据和趋势分析结果分别存储，自动清理90天前数据
- **Docker 部署**：完整的容器化解决方案
- **速率限制处理**：智能重试机制和API调用优化

## 快速开始

### 1. 克隆项目
```bash
git clone <your-repo-url>
cd trendBot
```

### 2. 配置环境变量
```bash
cp .env.example .env
# 编辑 .env 文件，填入你的 API 密钥和配置
```

### 3. 启动服务
```bash
docker-compose up -d
```

### 4. 查看日志
```bash
# 查看实时日志
docker-compose logs -f trend-bot

# 查看最近的日志
docker-compose logs --tail=50 trend-bot

# 查看所有服务日志
docker-compose logs -f
```

## 初始化过程

### 首次启动
系统首次启动时会自动执行完整的初始化流程：

1. **数据库初始化**: 自动创建必要的数据表
   - `crypto_5min_data`: 存储5分钟原始数据和技术指标
   - `crypto_trends`: 存储各时间框架的趋势分析结果
2. **数据检查**: 检查数据库中现有的数据量
3. **历史数据获取**: 如果数据不足，自动获取历史数据
   - 受API限制，每次最多获取20个数据点
   - 多批次获取：3批次 × 5个时间间隔 = 总共约300个数据点
   - 时间间隔：5分钟、15分钟、1小时、4小时、1天
4. **数据转换**: 将不同时间间隔的数据转换为统一的5分钟数据点
5. **就绪检查**: 确认各时间框架有足够数据进行分析

### API限制处理
- **速率限制**: 系统会自动处理TAAPI.io的速率限制
- **批次限制**: 每次请求最多20个结果，系统会分批获取
- **容错机制**: 即使初始化失败，系统仍会正常启动
- **渐进增强**: 随着时间推移，数据会自然积累，分析能力逐步提升

### 数据充足性要求
- **15分钟分析**: 至少需要60个5分钟数据点（5小时）
- **1小时分析**: 至少需要240个5分钟数据点（20小时）
- **4小时分析**: 至少需要1000个5分钟数据点（3-4天）
- **1天分析**: 至少需要2000个5分钟数据点（7天）
- **1周分析**: 至少需要10000个5分钟数据点（35天）

### 渐进式分析
- 系统启动后会根据数据充足性逐步启用不同时间框架的分析
- 数据不足的时间框架会显示"数据积累中"状态
- 随着数据积累，更多时间框架的分析会自动启用

## 环境变量说明

- `TAAPI_KEY`: TAAPI.io 的 API 密钥
- `TELEGRAM_TOKEN`: Telegram 机器人 Token
- `TELEGRAM_CHAT_ID`: Telegram 聊天 ID
- `MYSQL_HOST`: MySQL 主机地址（Docker 环境下为 `mysql`）
- `MYSQL_USER`: MySQL 用户名
- `MYSQL_PASSWORD`: MySQL 密码
- `MYSQL_DB`: MySQL 数据库名
- `MYSQL_ROOT_PASSWORD`: MySQL root 密码

## 数据架构与多时间框架分析

### 数据收集策略
1. **API调用**: 每5分钟只调用一次API获取5分钟K线数据
2. **数据存储**: 将5分钟OHLCV数据和技术指标存储到数据库
3. **时间框架计算**: 基于数据库中的5分钟数据聚合计算其他时间框架

### 时间框架与趋势有效期
- **15分钟**: 超短期趋势，适合快速交易
  - 数据聚合：3个5分钟数据
  - 预期有效期：1-4小时（强趋势4小时，弱趋势1小时）
- **1小时**: 短期趋势，适合日内交易
  - 数据聚合：12个5分钟数据
  - 预期有效期：4-24小时（强趋势24小时，弱趋势6小时）
- **4小时**: 中短期趋势，适合短线操作
  - 数据聚合：48个5分钟数据
  - 预期有效期：1-7天（强趋势7天，弱趋势1天）
- **1天**: 中长期趋势，适合趋势跟踪
  - 数据聚合：288个5分钟数据
  - 预期有效期：1-4周（强趋势4周，弱趋势1周）
- **1周**: 长期趋势，适合长线投资
  - 数据聚合：2016个5分钟数据
  - 预期有效期：1-6个月（强趋势6个月，弱趋势1个月）

### 技术指标
- **ADX**: 平均趋向指数，判断趋势强度
- **+DI/-DI**: 正负方向指标，判断趋势方向
- **SMA50/200**: 50期和200期简单移动平均线
- **布林带**: 判断价格波动率
- **ATR**: 真实波动幅度

### 趋势判断逻辑
不同时间框架使用不同的阈值：
- **强趋势**: ADX > 阈值 且方向指标明确 且均线排列
- **中等趋势**: ADX > 较低阈值 且方向偏向明确
- **区间震荡**: ADX 较低 且波动率低
- **基于均线**: SMA50 与 SMA200 差异显著

### 数据存储结构
- **crypto_5min_data**: 存储5分钟原始数据和指标
- **crypto_trends**: 存储各时间框架的趋势分析结果

### 数据管理
- **API效率**: 每个币种每5分钟只调用一次API（获取5分钟数据）
- **数据聚合**: 基于5分钟数据计算15分钟、1小时、4小时、1天、1周指标
- **分析频率**: 每5分钟分析所有时间框架趋势
- **数据保留**: 自动清理90天前的历史数据
- **存储优化**: 使用 ON DUPLICATE KEY UPDATE 避免重复数据
- **趋势有效期**: 根据ADX强度自动计算和跟踪趋势预测有效期
- **过期管理**: 每日自动标记过期的趋势预测

### 专业技术指标计算 (pandas-ta)
- **SMA**: 使用pandas-ta计算50期和200期简单移动平均线
- **ADX**: 使用pandas-ta计算14期平均趋向指数，判断趋势强度
- **DMI**: 使用pandas-ta计算+DI和-DI，判断趋势方向
- **布林带**: 使用pandas-ta计算20期布林带，分析价格波动
- **ATR**: 使用pandas-ta计算14期真实波动幅度

### 趋势预测有效期管理

#### 有效期计算逻辑
- **强趋势** (ADX > 30): 使用最大有效期
- **中等趋势** (ADX 20-30): 使用中等有效期
- **弱趋势** (ADX < 20): 使用最小有效期，并添加反转风险警告

#### 风险提醒机制
- **短期趋势** (15分钟/1小时): 自动添加"易受突发事件影响"警告
- **弱趋势**: 自动添加"注意反转风险"警告
- **过期趋势**: 每日自动标记过期的趋势预测

#### 实际应用建议
- **超短期交易**: 关注15分钟和1小时趋势，但要快速止损
- **日内交易**: 主要参考1小时和4小时趋势
- **波段交易**: 重点关注4小时和1天趋势
- **长线投资**: 以1天和1周趋势为主要参考

### 数据质量保证
- **数据验证**: 过滤无效价格数据（价格<=0）
- **完整性检查**: 确保OHLC数据逻辑正确（H>=L, 价格>0）
- **充足数据**: 确保至少200个周期用于SMA200计算
- **NaN处理**: 使用pandas自动处理和清理NaN值
- **跨平台兼容**: pandas-ta纯Python实现，支持ARM64等各种架构

## 管理命令

```bash
# 启动服务
docker-compose up -d

# 停止服务
docker-compose down

# 重启服务
docker-compose restart

# 查看日志
docker-compose logs -f trend-bot

# 进入容器
docker-compose exec trend-bot bash

# 检查容器状态
docker-compose ps

# 调试模式启动（查看详细日志）
docker-compose up --no-daemon
```