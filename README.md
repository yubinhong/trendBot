# 加密货币趋势监控机器人

基于技术指标分析的加密货币趋势监控机器人，支持 BTC 和 ETH 的实时趋势分析和 Telegram 通知。

## 功能特性

- **多时间框架分析**：5分钟、15分钟、1小时、4小时、1天趋势监控
- **高频数据收集**：每5分钟收集5分钟K线数据并存储到数据库
- **智能分析**：基于 ADX、DMI、SMA、布林带、ATR 等技术指标
- **趋势通知**：任何时间框架趋势变化时自动发送 Telegram 通知
- **数据管理**：原始数据和趋势分析结果分别存储，自动清理90天前数据
- **Docker 部署**：完整的容器化解决方案
- **速率限制处理**：智能重试机制和API调用优化



## 快速开始

### 1. 克隆项目
```bash
git clone <your-repo-url>
cd trendBot
```

### 2. 配置环境变量
```bash
cp .env.example .env
# 编辑 .env 文件，填入你的 API 密钥和配置
```

### 3. 启动服务
```bash
# 启动趋势监控机器人
docker-compose up -d
```

### 4. 查看日志
```bash
# 查看趋势机器人日志
docker-compose logs -f trend-bot

# 查看所有服务日志
docker-compose logs -f
```

## 本地开发

```bash
# 安装依赖
pip install -r requirements.txt

# 启动数据库
docker-compose up -d mysql

# 运行趋势监控机器人
python main.py
```

## 初始化过程

### 首次启动
系统首次启动时会自动执行完整的初始化流程：

1. **数据库初始化**: 自动创建必要的数据表
   - `crypto_5min_data`: 存储5分钟原始数据和技术指标
   - `crypto_trends`: 存储各时间框架的趋势分析结果
2. **数据检查**: 检查数据库中现有的数据量
3. **历史数据获取**: 如果数据不足，自动获取5分钟历史数据
   - 分批获取约9,000个5分钟K线数据（约31天历史）
   - 完全支持15分钟、1小时、4小时趋势分析
   - 为1天趋势提供基础分析能力，随时间积累逐步完善
   - 基于5分钟数据聚合计算所有其他时间框架
4. **数据转换**: 将不同时间间隔的数据转换为统一的5分钟数据点
5. **就绪检查**: 确认各时间框架有足够数据进行分析

### Binance API 优势
- **免费使用**: 无需API密钥，完全免费
- **宽松限制**: 每分钟1200次请求，远超实际需求
- **大量数据**: 每次可获取最多1000条K线数据
- **高质量数据**: 直接从交易所获取原始OHLCV数据
- **快速初始化**: 几秒内即可获取数年历史数据
- **稳定可靠**: 币安作为全球最大交易所，API稳定性极高

### 数据充足性要求
- **15分钟分析**: 至少需要60个5分钟数据点（5小时）
- **1小时分析**: 至少需要240个5分钟数据点（20小时）
- **4小时分析**: 至少需要1000个5分钟数据点（3-4天）
- **1天分析**: 至少需要5000个5分钟数据点（17天基础分析）

### 1天趋势分析说明
- **完整分析**: 需要57,600个5分钟数据点（200天）用于SMA200计算
- **基础分析**: 5000个数据点可以开始基本趋势判断
- **渐进改善**: 随着数据积累，1天趋势分析会逐步完善
- **实用策略**: 系统优先确保短期分析（15分钟-4小时）的准确性

### 渐进式分析
- 系统启动后会根据数据充足性逐步启用不同时间框架的分析
- 数据不足的时间框架会显示"数据积累中"状态
- 随着数据积累，更多时间框架的分析会自动启用

## 环境变量说明

- `TELEGRAM_TOKEN`: Telegram 机器人 Token
- `TELEGRAM_CHAT_ID`: Telegram 聊天 ID
- `MYSQL_HOST`: MySQL 主机地址（Docker 环境下为 `mysql`）
- `MYSQL_USER`: MySQL 用户名
- `MYSQL_PASSWORD`: MySQL 密码
- `MYSQL_DB`: MySQL 数据库名
- `MYSQL_ROOT_PASSWORD`: MySQL root 密码
- `SKIP_INITIALIZATION`: 跳过历史数据初始化（可选，设为 `true` 立即启动）

## 数据架构与多时间框架分析

### 数据收集策略
1. **Binance API**: 每5分钟调用Binance免费API获取K线数据
2. **数据存储**: 将5分钟OHLCV数据和计算的技术指标存储到数据库
3. **时间框架计算**: 基于数据库中的5分钟数据聚合计算其他时间框架

### 时间框架与趋势有效期
- **5分钟**: 极短期趋势，适合高频交易和短期信号确认
  - 数据聚合：单个5分钟数据
  - 预期有效期：10-30分钟（强趋势30分钟，弱趋势10分钟）
  - 特点：波动性大，需结合更长时间框架使用
- **15分钟**: 超短期趋势，适合快速交易
  - 数据聚合：3个5分钟数据
  - 预期有效期：1-4小时（强趋势4小时，弱趋势1小时）
- **1小时**: 短期趋势，适合日内交易
  - 数据聚合：12个5分钟数据
  - 预期有效期：4-24小时（强趋势24小时，弱趋势6小时）
- **4小时**: 中短期趋势，适合短线操作
  - 数据聚合：48个5分钟数据
  - 预期有效期：1-7天（强趋势7天，弱趋势1天）
- **1天**: 中长期趋势，适合趋势跟踪
  - 数据聚合：288个5分钟数据
  - 预期有效期：1-4周（强趋势4周，弱趋势1周）

### 技术指标
- **ADX**: 平均趋向指数，判断趋势强度
- **+DI/-DI**: 正负方向指标，判断趋势方向
- **SMA50/200**: 50期和200期简单移动平均线
- **布林带**: 判断价格波动率
- **ATR**: 真实波动幅度

### 趋势判断逻辑
不同时间框架使用不同的阈值：
- **强趋势**: ADX > 阈值 且方向指标明确 且均线排列
- **中等趋势**: ADX > 较低阈值 且方向偏向明确
- **区间震荡**: ADX 较低 且波动率低
- **基于均线**: SMA50 与 SMA200 差异显著

### 数据存储结构
- **crypto_5min_data**: 存储5分钟原始数据和指标
- **crypto_trends**: 存储各时间框架的趋势分析结果

### 数据管理
- **免费API**: 使用Binance免费API，无需API密钥
- **高效获取**: 每次获取300个5分钟K线数据，包含足够历史数据用于指标计算
- **数据聚合**: 基于5分钟数据计算15分钟、1小时、4小时、1天、1周指标
- **分析频率**: 每5分钟分析所有时间框架趋势
- **数据保留**: 自动清理250天前的5分钟数据，90天前的趋势数据
- **存储优化**: 使用 ON DUPLICATE KEY UPDATE 避免重复数据
- **趋势有效期**: 根据ADX强度自动计算和跟踪趋势预测有效期
- **过期管理**: 每日自动标记过期的趋势预测

### 专业技术指标计算 (pandas-ta)
- **SMA**: 使用pandas-ta计算50期和200期简单移动平均线
- **ADX**: 使用pandas-ta计算14期平均趋向指数，判断趋势强度
- **DMI**: 使用pandas-ta计算+DI和-DI，判断趋势方向
- **布林带**: 使用pandas-ta计算20期布林带，分析价格波动
- **ATR**: 使用pandas-ta计算14期真实波动幅度

### 趋势预测有效期管理

#### 有效期计算逻辑
- **强趋势** (ADX > 30): 使用最大有效期
- **中等趋势** (ADX 20-30): 使用中等有效期
- **弱趋势** (ADX < 20): 使用最小有效期，并添加反转风险警告

#### 风险提醒机制
- **短期趋势** (15分钟/1小时): 自动添加"易受突发事件影响"警告
- **弱趋势**: 自动添加"注意反转风险"警告
- **过期趋势**: 每日自动标记过期的趋势预测

#### 实际应用建议
- **超短期交易**: 关注15分钟和1小时趋势，但要快速止损
- **日内交易**: 主要参考1小时和4小时趋势
- **波段交易**: 重点关注4小时和1天趋势
- **长线投资**: 以1天趋势为主要参考

### 数据质量保证
- **数据验证**: 过滤无效价格数据（价格<=0）
- **完整性检查**: 确保OHLC数据逻辑正确（H>=L, 价格>0）
- **充足数据**: 确保至少200个周期用于SMA200计算
- **NaN处理**: 使用pandas自动处理和清理NaN值
- **跨平台兼容**: pandas-ta纯Python实现，支持ARM64等各种架构

## 多时间框架趋势分析指南

### 时间框架的层次关系

**时间框架从短到长**：15分钟 → 1小时 → 4小时 → 1天

- **15分钟**：反映最近几小时的价格行为
- **1小时**：反映最近几天的价格行为  
- **4小时**：反映最近几周的价格行为
- **1天**：反映最近几个月的价格行为

### 趋势一致性分析

#### 情况1：所有时间框架趋势一致
**例子**：15分钟↓、1小时↓、4小时↓、1天↓

**含义**：
- 这是**最强的信号**，表明从短期到长期都在同一方向
- 趋势延续的概率很高
- 适合顺势交易

#### 情况2：短期与长期趋势相反
**例子**：15分钟↓、1小时↓、4小时↑、1天↑

**含义**：
- 长期趋势向上，但短期出现回调
- 可能是**买入机会**（在上涨趋势中的回调）
- 或者是长期趋势即将反转的信号

#### 情况3：趋势混合
**例子**：15分钟↓、1小时↑、4小时震荡、1天↑

**含义**：
- 市场处于**转换期**
- 不同时间框架的力量在博弈
- 建议等待更明确的信号

### 实际应用策略

#### 交易时间框架选择

1. **日内交易者**：主要看15分钟和1小时
2. **短线交易者**：重点关注1小时和4小时
3. **波段交易者**：以4小时和1天为主
4. **长线投资者**：主要参考1天趋势

#### 信号强度排序

**最强信号**（按可靠性排序）：
1. **四个时间框架同向** - 可靠性95%
2. **三个时间框架同向** - 可靠性80%
3. **长期时间框架主导** - 可靠性70%
4. **短期时间框架主导** - 可靠性50%

#### 具体案例分析

**案例A：强势上涨**
- 15分钟：上涨 ✅
- 1小时：上涨 ✅  
- 4小时：上涨 ✅
- 1天：上涨 ✅

**解读**：非常强的上涨信号，适合做多

**案例B：长期上涨中的短期调整**
- 15分钟：下跌 ❌
- 1小时：下跌 ❌
- 4小时：上涨 ✅
- 1天：上涨 ✅

**解读**：长期趋势向上，短期回调，可能是买入机会

**案例C：趋势转换期**
- 15分钟：上涨 ✅
- 1小时：震荡 ⚪
- 4小时：下跌 ❌
- 1天：下跌 ❌

**解读**：可能是下跌趋势中的反弹，或趋势即将反转

### 注意事项

#### 1. 时间框架权重
- **长期时间框架权重更高**：1天 > 4小时 > 1小时 > 15分钟
- 长期趋势通常会主导短期趋势

#### 2. 趋势强度考虑
- 系统会显示ADX强度
- ADX > 30 = 强趋势，更可靠
- ADX < 20 = 弱趋势，容易反转

#### 3. 市场环境影响
- **牛市**：上涨信号更可靠，下跌可能是回调
- **熊市**：下跌信号更可靠，上涨可能是反弹
- **震荡市**：趋势信号可靠性降低

### 最佳实践

#### 交易策略：
1. **优先看长期时间框架**确定主趋势
2. **用短期时间框架**寻找入场时机
3. **等待多时间框架共振**再采取行动
4. **设置止损**基于更高时间框架的关键位

#### 风险管理：
- 当时间框架冲突时，**降低仓位**
- 当所有时间框架一致时，可以**增加仓位**
- 始终关注**长期趋势方向**

#### 通知解读：
- 🟢 上涨趋势：做多信号
- 🔴 下跌趋势：做空信号
- 🟡 区间震荡：等待突破
- ⚪ 信号混合：观察关键位
- ⏳ 数据积累中：等待更多数据
- (基础) 标识：分析会持续改善

## 管理命令

```bash
# 启动服务
docker-compose up -d

# 停止服务
docker-compose down

# 重启服务
docker-compose restart

# 查看日志
docker-compose logs -f trend-bot

# 进入容器
docker-compose exec trend-bot bash

# 检查容器状态
docker-compose ps

# 调试模式启动（查看详细日志）
docker-compose up --no-daemon
```